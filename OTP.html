<!DOCTYPE html>
<html lang="id">

<head>
    <meta charset="utf-8">
    <title>Bookmarklet Kode OTP</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <!-- Bootstrap 5 -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body {
            background: #f4f6f8;
        }

        pre#output {
            background: #1e1e1e;
            color: #00ff88;
            padding: 15px;
            border-radius: 6px;
            font-family: monospace;
            white-space: pre-wrap;
            max-height: 400px;
            overflow-y: auto;
        }
    </style>
</head>

<body>
    <div class="container py-4">

        <div class="card shadow-lg">
            <div class="card-body">
                <h1 class="h3 mb-3">‚≠ê Bookmarklet Kode OTP</h1>

                <div class="d-flex justify-content-between mb-3">
                    <small>
                        Tutorial: <a href="https://youtu.be/29o-ych59Os" target="_blank" class="link-primary">‚ñ∂Ô∏è Youtube
                            - @danie_lung</a>
                    </small>
                    <small>
                        Ajak Ngopi: <a href="https://s.id/danielung" target="_blank" class="link-primary">‚òïÔ∏è Tubruk</a>
                    </small>
                </div>

                <hr>
                <h5 class="mb-2">üëâ Generator Bookmarklet</h5>
                <p class="text-muted">Masukkan kode secret untuk menghasilkan bookmarklet OTP. Kode OTP akan langsung
                    terisi sesuai penggunaan yang dipilih.</p>

                <div class="mb-3">
                    <input type="text" id="bookmarkletCode" class="form-control" placeholder="Masukkan Kode Secret">
                </div>
                <div class="mb-3">
                    <input type="text" id="bookmarkletNama" class="form-control"
                        placeholder="Masukkan Nama Bookmarklet">
                </div>

                <label class="form-label">Pilih Penggunaan OTP:</label>
                <div class="mb-3">
                    <div class="form-check form-check-inline">
                        <input class="form-check-input" type="radio" name="bmOption" id="radioDapodik" value="kode2fa"
                            checked>
                        <label class="form-check-label" for="radioDapodik">Dapodik</label>
                    </div>
                    <div class="form-check form-check-inline">
                        <input class="form-check-input" type="radio" name="bmOption" id="radioSDM" value="totp_code">
                        <label class="form-check-label" for="radioSDM">SDM</label>
                    </div>
                    <div class="form-check form-check-inline">
                        <input class="form-check-input" type="radio" name="bmOption" id="radioSIASN" value="otp">
                        <label class="form-check-label" for="radioSIASN">SIASN</label>
                    </div>
                </div>

                <button class="btn btn-primary" onclick="generateBookmarklet()">üöÄ Generate Bookmarklet</button>

                <p class="mt-3">Bookmarklet: <a id="bookmarkletLink" href="#" target="_blank" class="fw-bold"></a></p>

                <hr>
                <h5 class="mb-2">üëâ Google Authenticator QR Decoder</h5>
                <p class="text-muted">Unggah gambar kode QR 2FA untuk mengekstrak akun dan secret-nya.</p>

                <input type="file" id="fileInput" accept="image/*" class="form-control mb-3">
                <pre id="output">Silakan Upload QR Google Authenticator</pre>

                <div class="text-center mt-4">
                    üìÇ Lihat kode sumber di
                    <a href="https://github.com/danie-lung/bookmarklet_kode_otp" target="_blank"
                        class="link-dark fw-semibold">GitHub</a>
                </div>
            </div>
        </div>

    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/protobufjs/dist/protobuf.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jsqr/dist/jsQR.js"></script>

    <script>
        document.getElementById('fileInput').addEventListener('change', handleFile);

        function handleFile(evt) {
            const file = evt.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = function (e) {
                const img = new Image();
                img.onload = function () {
                    const canvas = document.createElement('canvas');
                    canvas.width = img.width; canvas.height = img.height;
                    const ctx = canvas.getContext('2d');
                    ctx.drawImage(img, 0, 0);
                    const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
                    const code = jsQR(imageData.data, imageData.width, imageData.height);
                    if (code) processQR(code.data);
                    else document.getElementById('output').textContent = "‚ùå QR code tidak terbaca.";
                };
                img.src = e.target.result;
            };
            reader.readAsDataURL(file);
        }

        function processQR(qrText) {
            try {
                if (qrText.startsWith("otpauth://")) {
                    const url = new URL(qrText);
                    const secret = url.searchParams.get("secret");
                    const issuer = url.searchParams.get("issuer") || "(tidak ada)";
                    const label = decodeURIComponent(url.pathname.replace(/^\/\//, ''));
                    if (secret) {
                        document.getElementById('output').textContent =
                            `üìå OTP Auth\nNama   : ${label}\nIssuer : ${issuer}\nSecret : ${secret}`;
                    } else {
                        document.getElementById('output').textContent = "‚ö†Ô∏è Secret tidak ditemukan di QR.";
                    }
                    return;
                }
                const url = new URL(qrText);
                let dataParam = url.searchParams.get("data");
                if (!dataParam) {
                    document.getElementById('output').textContent = "‚ö†Ô∏è Parameter data= tidak ditemukan.";
                    return;
                }
                dataParam = dataParam.replace(/ /g, '+').replace(/%20/g, '+').replace(/%2B/gi, '+');
                const binary = atob(dataParam);
                const bytes = new Uint8Array(binary.length);
                for (let i = 0; i < binary.length; i++) bytes[i] = binary.charCodeAt(i);
                const root = protobuf.Root.fromJSON({
                    nested: {
                        MigrationPayload: {
                            fields: {
                                otpParameters: { rule: "repeated", type: "OtpParameters", id: 1 },
                                version: { type: "int32", id: 2 },
                                batchSize: { type: "int32", id: 3 },
                                batchIndex: { type: "int32", id: 4 },
                                batchId: { type: "bytes", id: 5 }
                            }
                        },
                        OtpParameters: {
                            fields: {
                                secret: { type: "bytes", id: 1 },
                                name: { type: "string", id: 2 },
                                issuer: { type: "string", id: 3 },
                                algorithm: { type: "int32", id: 4 },
                                digits: { type: "int32", id: 5 },
                                type: { type: "int32", id: 6 },
                                counter: { type: "int64", id: 7 }
                            }
                        }
                    }
                });
                const MigrationPayload = root.lookupType("MigrationPayload");
                const payload = MigrationPayload.decode(bytes);
                if (!payload.otpParameters || payload.otpParameters.length === 0) {
                    document.getElementById('output').textContent = "‚ö†Ô∏è Tidak ada akun ditemukan di payload migrasi.";
                    return;
                }
                let result = "";
                payload.otpParameters.forEach((param, i) => {
                    const secretBase32 = base32Encode(param.secret);
                    result += `üìå Akun ${i + 1}\nNama   : ${param.name}\nIssuer : ${param.issuer}\nSecret : ${secretBase32}\n\n`;
                });
                document.getElementById('output').textContent = result;
            } catch (err) {
                document.getElementById('output').textContent = "‚ùå Error: " + err.message;
            }
        }

        function base32Encode(bytes) {
            const alphabet = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ234567';
            let bits = 0, value = 0, output = '';
            for (let i = 0; i < bytes.length; i++) {
                value = (value << 8) | bytes[i];
                bits += 8;
                while (bits >= 5) {
                    output += alphabet[(value >>> (bits - 5)) & 31];
                    bits -= 5;
                }
            }
            if (bits > 0) output += alphabet[(value << (5 - bits)) & 31];
            return output;
        }

        function generateBookmarklet() {
            const code = document.getElementById("bookmarkletCode").value.trim();
            const namacode = document.getElementById("bookmarkletNama").value.trim();
            const selected2fa = document.querySelector('input[name="bmOption"]:checked').value;
            if (!code) return alert("Masukkan kode secret terlebih dahulu.");
            if (!namacode) return alert("Masukkan nama bookmark terlebih dahulu.");
            let jsCode = `var secretKey="${code}";function base32Decode(e){for(var t=e.toUpperCase().replace(/=+$/,"").replace(/\\s+/g,""),r=0,n=0,a=[],o=0;o<t.length;o++){var c="ABCDEFGHIJKLMNOPQRSTUVWXYZ234567".indexOf(t[o]);if(-1===c)throw new Error("Invalid Base32 character: "+t[o]);n=n<<5|c,(r+=5)>=8&&(a.push(n>>>r-8&255),r-=8)}return new Uint8Array(a)}function intToBuffer(e){var t=new ArrayBuffer(8),r=new DataView(t),n=Math.floor(e/Math.pow(2,32)),a=e>>>0;return r.setUint32(0,n),r.setUint32(4,a),new Uint8Array(t)}function generateTOTP(e,t,r,n){t=t||6,r=r||30,n=n||"SHA-1";var a=base32Decode(e),o=Math.floor(Date.now()/1e3),c=intToBuffer(Math.floor(o/r));return crypto.subtle.importKey("raw",a,{name:"HMAC",hash:{name:n}},!1,["sign"]).then(function(e){return crypto.subtle.sign("HMAC",e,c)}).then(function(e){var r=new Uint8Array(e),n=15&r[r.length-1];return(((127&r[n])<<24|(255&r[n+1])<<16|(255&r[n+2])<<8|255&r[n+3])%Math.pow(10,t)).toString().padStart(t,"0")})}generateTOTP(secretKey).then(function(e){document.getElementById("${selected2fa}").value=e}).catch(function(e){alert("Error: "+e.message)});`;
            const bookmarklet = "javascript:(function(){" + encodeURIComponent(jsCode) + "})();";
            const link = document.getElementById("bookmarkletLink");
            link.href = bookmarklet;
            link.textContent = namacode;
        }
    </script>
</body>

</html>